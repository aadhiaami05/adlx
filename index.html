<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADLX FIXED</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; font-family: sans-serif; background: #0f172a; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 95%; height: 70vh; }
        .box { position: relative; background: #000; border-radius: 15px; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .controls { margin-top: 20px; display: flex; gap: 10px; }
        input { padding: 15px; border-radius: 10px; border: none; width: 200px; }
        button { padding: 15px 25px; border-radius: 10px; border: none; cursor: pointer; background: #3b82f6; color: white; font-weight: bold; }
        .status { position: fixed; top: 20px; color: #60a5fa; font-size: 14px; }
        .badge { position: absolute; top: 10px; right: 10px; background: red; padding: 5px; border-radius: 5px; font-size: 10px; display: none; }
        .active { display: block; }
    </style>
</head>
<body>

<div id="status" class="status">Enter Room Name to Begin</div>

<div id="setup">
    <input type="text" id="roomInput" placeholder="Room Name">
    <button onclick="init('host')">Host</button>
    <button onclick="init('join')" style="background: #10b981;">Join</button>
</div>

<div id="call-ui" style="display:none; width: 100%; text-align: center;">
    <div class="grid">
        <div class="box"><video id="local" autoplay playsinline muted></video></div>
        <div class="box"><video id="remote" autoplay playsinline></video>
            <div id="remote-mute" class="badge">PARTNER MUTED</div>
        </div>
    </div>
    <div class="controls">
        <button id="mBtn" onclick="toggle('mic')">Mic</button>
        <button id="vBtn" onclick="toggle('vid')">Cam</button>
        <button onclick="location.reload()" style="background:red">End</button>
    </div>
</div>

<script>
    let peer, myStream, room;
    const stat = (t) => document.getElementById('status').innerText = t;

    async function init(role) {
        room = document.getElementById('roomInput').value.trim().toLowerCase();
        if(!room) return alert("Enter room name");

        document.getElementById('setup').style.display = 'none';
        document.getElementById('call-ui').style.display = 'block';

        myStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
        document.getElementById('local').srcObject = myStream;

        // Predictable IDs: "roomname-host" and "roomname-join"
        const myID = room + '-' + role;
        const targetID = room + '-' + (role === 'host' ? 'join' : 'host');

        peer = new Peer(myID, {
            config: {'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }]}
        });

        peer.on('open', () => {
            stat("Room: " + room + " | Role: " + role.toUpperCase());
            if(role === 'join') {
                stat("Connecting to host...");
                const call = peer.call(targetID, myStream);
                handleCall(call);
            }
        });

        peer.on('call', (call) => {
            stat("Partner connected!");
            call.answer(myStream);
            handleCall(call);
        });

        peer.on('error', (e) => {
            if(e.type === 'peer-unavailable' && role === 'join') {
                stat("Host not found. Ask friend to click 'Host' first.");
            } else {
                stat("Error: " + e.type);
            }
        });
    }

    function handleCall(call) {
        call.on('stream', (s) => {
            document.getElementById('remote').srcObject = s;
        });
    }

    function toggle(type) {
        const track = type === 'mic' ? myStream.getAudioTracks()[0] : myStream.getVideoTracks()[0];
        track.enabled = !track.enabled;
        const btn = document.getElementById(type === 'mic' ? 'mBtn' : 'vBtn');
        btn.style.background = track.enabled ? '#3b82f6' : '#ef4444';
    }
</script>
</body>
</html>
