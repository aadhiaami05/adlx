<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Easy Room Video - Status Pro</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <style>
        :root { --bg: #0f172a; --accent: #3b82f6; --danger: #ef4444; --text: #f8fafc; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); }
        .setup { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        #video-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; padding: 20px; }
        
        .video-wrapper { position: relative; background: #000; border-radius: 12px; overflow: hidden; aspect-ratio: 16/9; border: 2px solid transparent; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* Indicators */
        .status-icons { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; }
        .badge { background: rgba(0,0,0,0.6); padding: 4px 8px; border-radius: 4px; font-size: 12px; display: none; }
        .badge.active { display: block; }
        .name-tag { position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.5); padding: 2px 8px; border-radius: 4px; font-size: 12px; }

        .controls { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; background: rgba(30, 41, 59, 0.8); padding: 15px; border-radius: 50px; backdrop-filter: blur(10px); }
        button { padding: 10px 20px; border-radius: 20px; border: none; cursor: pointer; background: var(--accent); color: white; font-weight: bold; transition: 0.2s; }
        button.off { background: var(--danger); }
        input { padding: 12px; border-radius: 8px; border: none; width: 220px; margin-bottom: 10px; background: #334155; color: white; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="setup-screen" class="setup">
    <h2>Join a Room</h2>
    <input type="text" id="room-id" placeholder="Enter Room Name">
    <button onclick="startApp()">Join Room</button>
</div>

<div id="call-screen" class="hidden">
    <div id="video-grid">
        <div class="video-wrapper" id="local-wrapper">
            <video id="localVideo" autoplay playsinline muted></video>
            <div class="name-tag">You</div>
            <div class="status-icons">
                <span id="local-mic-badge" class="badge" style="background:var(--danger)">Muted</span>
                <span id="local-cam-badge" class="badge" style="background:var(--danger)">Video Off</span>
            </div>
        </div>
    </div>

    <div class="controls">
        <button id="mic-btn" onclick="toggleAudio()">ðŸŽ¤ Mic On</button>
        <button id="cam-btn" onclick="toggleVideo()">ðŸ“· Cam On</button>
        <button style="background:var(--danger)" onclick="location.reload()">Leave</button>
    </div>
</div>

<script>
    const pcConfig = { config: {'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }]}};
    const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
    const peer = new Peer(undefined, pcConfig);
    let myStream, myID, currentRoom;

    async function startApp() {
        const roomCode = document.getElementById('room-id').value;
        if (!roomCode) return alert("Enter a room name!");

        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('call-screen').classList.remove('hidden');

        myStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('localVideo').srcObject = myStream;

        peer.on('open', (id) => {
            myID = id;
            currentRoom = gun.get('status-rooms').get(roomCode);
            
            // 1. Announce Presence
            currentRoom.get(myID).put({ mic: true, cam: true });

            // 2. Listen for others
            currentRoom.map().on((data, peerID) => {
                if (peerID !== myID && data) {
                    // Update UI if user already exists, else call them
                    if (document.getElementById(peerID)) {
                        updateRemoteStatus(peerID, data);
                    } else {
                        const call = peer.call(peerID, myStream);
                        addRemoteVideo(call);
                    }
                }
            });
        });

        peer.on('call', call => {
            call.answer(myStream);
            addRemoteVideo(call);
        });
    }

    function addRemoteVideo(call) {
        if (document.getElementById(call.peer)) return;
        const video = document.createElement('video');
        const wrapper = document.createElement('div');
        wrapper.className = 'video-wrapper';
        wrapper.id = call.peer;
        
        wrapper.innerHTML = `
            <div class="name-tag">Partner</div>
            <div class="status-icons">
                <span id="mic-${call.peer}" class="badge" style="background:var(--danger)">Muted</span>
                <span id="cam-${call.peer}" class="badge" style="background:var(--danger)">Video Off</span>
            </div>
        `;
        
        call.on('stream', remoteStream => {
            video.srcObject = remoteStream;
            video.autoplay = true;
            wrapper.prepend(video);
            document.getElementById('video-grid').append(wrapper);
        });
    }

    function updateRemoteStatus(peerID, data) {
        const micB = document.getElementById(`mic-${peerID}`);
        const camB = document.getElementById(`cam-${peerID}`);
        if(micB) micB.classList.toggle('active', !data.mic);
        if(camB) camB.classList.toggle('active', !data.cam);
    }

    // Toggle and Sync to Database
    function toggleAudio() {
        const enabled = myStream.getAudioTracks()[0].enabled = !myStream.getAudioTracks()[0].enabled;
        document.getElementById('mic-btn').innerText = enabled ? "ðŸŽ¤ Mic On" : "ðŸ”‡ Mic Off";
        document.getElementById('mic-btn').classList.toggle('off', !enabled);
        document.getElementById('local-mic-badge').classList.toggle('active', !enabled);
        currentRoom.get(myID).patch({ mic: enabled });
    }

    function toggleVideo() {
        const enabled = myStream.getVideoTracks()[0].enabled = !myStream.getVideoTracks()[0].enabled;
        document.getElementById('cam-btn').innerText = enabled ? "ðŸ“· Cam On" : "ðŸš« Cam Off";
        document.getElementById('cam-btn').classList.toggle('off', !enabled);
        document.getElementById('local-cam-badge').classList.toggle('active', !enabled);
        currentRoom.get(myID).patch({ cam: enabled });
    }
</script>
</body>
</html>
